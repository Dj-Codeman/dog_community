[build.env]
passthrough = ["OPENSSL_STATIC", "PKG_CONFIG_ALLOW_CROSS"]

# --- x86_64-unknown-linux-musl ---
[target.x86_64-unknown-linux-musl]
pre-build = [
  "bash -lc \"apt-get update && apt-get install -y --no-install-recommends curl ca-certificates build-essential perl file make pkg-config && rm -rf /var/lib/apt/lists/*\"",
  "bash -lc 'set -eux; v=3.3.1; curl -fsSL https://www.openssl.org/source/openssl-${v}.tar.gz -o /tmp/openssl.tar.gz; tar -xzf /tmp/openssl.tar.gz -C /tmp; cd /tmp/openssl-${v}; ./Configure linux-x86_64 no-shared no-tests --prefix=/opt/openssl/x86_64-unknown-linux-musl --cross-compile-prefix=x86_64-linux-musl- ; make -j$(nproc); make install_sw; rm -rf /tmp/openssl*'"
]

# --- i686-unknown-linux-musl ---
[target.i686-unknown-linux-musl]
pre-build = [
  "bash -lc \"apt-get update && apt-get install -y --no-install-recommends curl ca-certificates build-essential perl file make pkg-config && rm -rf /var/lib/apt/lists/*\"",
  "bash -lc 'set -eux; v=3.3.1; curl -fsSL https://www.openssl.org/source/openssl-${v}.tar.gz -o /tmp/openssl.tar.gz; tar -xzf /tmp/openssl.tar.gz -C /tmp; cd /tmp/openssl-${v}; ./Configure linux-x86 no-shared no-tests --prefix=/opt/openssl/i686-unknown-linux-musl --cross-compile-prefix=i686-linux-musl- ;  make -j$(nproc); make install_sw; rm -rf /tmp/openssl*'"
]

# --- aarch64-unknown-linux-musl ---
[target.aarch64-unknown-linux-musl]
pre-build = [
  "bash -lc \"apt-get update && apt-get install -y --no-install-recommends curl ca-certificates build-essential perl file make pkg-config && rm -rf /var/lib/apt/lists/*\"",
  "bash -lc 'set -eux; v=3.3.1; curl -fsSL https://www.openssl.org/source/openssl-${v}.tar.gz -o /tmp/openssl.tar.gz; tar -xzf /tmp/openssl.tar.gz -C /tmp; cd /tmp/openssl-${v}; ./Configure linux-aarch64 no-shared no-tests --prefix=/opt/openssl/aarch64-unknown-linux-musl --cross-compile-prefix=aarch64-linux-musl- ; make -j$(nproc); make install_sw; rm -rf /tmp/openssl*'"
]

# --- armv7-unknown-linux-musleabihf ---
[target.armv7-unknown-linux-musleabihf]
pre-build = [
  "bash -lc \"apt-get update && apt-get install -y --no-install-recommends curl ca-certificates build-essential perl file make pkg-config && rm -rf /var/lib/apt/lists/*\"",
  # Use linux-armv4 config and force ARMv7 hard-float flags; use the musl hard-float triplet prefix.
  "bash -lc 'set -eux; v=3.3.1; curl -fsSL https://www.openssl.org/source/openssl-${v}.tar.gz -o /tmp/openssl.tar.gz; tar -xzf /tmp/openssl.tar.gz -C /tmp; cd /tmp/openssl-${v}; ./Configure linux-armv4 no-shared no-tests --prefix=/opt/openssl/armv7-unknown-linux-musleabihf --cross-compile-prefix=arm-linux-musleabihf- -march=armv7-a -mfpu=vfpv3-d16 -mfloat-abi=hard ; make -j$(nproc); make install_sw; rm -rf /tmp/openssl*'"
]